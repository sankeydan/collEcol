---
title: "Fission Analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}

rm(list= ls()) # Clear your workspace 

load( file.path( PROJHOME ,  "smallDFs" , "metrics.rda")) # load the file "metrics.rda"

head(metrics)
```

This file contains 1276 rows of information about each individual flight. For some flights the GPS may have not been attached (early flights in particular) or may have malfunctioned, but the rest contain information about the flight, as well as flight parameters such as accuracy and speed 

Now, more cleaning of the data so only pigeons which finihed the study are included in the data. 



```{r}
#type = "all pigeons"
type = "finishers" # for now choose finishers

if ( type == "finishers"){

  metrics = metrics[-c(which(metrics$pigeon == 40),
                       which(metrics$pigeon== 41) ,
                       which(metrics$pigeon== 57 ),
                       which(metrics$pigeon== 83 ),
                       which(metrics$pigeon== 90 )),] # these are the pigeons that for one reason or another, did not make it to the end of the study

}

group.vec = c(7,10) # This is how many individuals were in each group.
```



# Solo speeds 

```{r}

solo.speed.data = matrix(NA, ncol = length(unique(metrics$pigeon)),
                             nrow = length(metrics$mean.speed[metrics$pigeon == 39 & # 39 is just a random pigeon number, this will give us the                                                                                          #  correct number of rows
                                                              metrics$g_s == "Sol" & # Needs to be solo flights only
                                                              metrics$f_u == "F"]))  # Only familiar flights for now so site differences are taken                                                                                        # into account

for (i in 1:length(unique(metrics$pigeon))){ # for each unique pigeon

  solo.speed.data[,i] =  metrics$mean.speed[metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Sol" & metrics$f_u == "F"]
   # get mean speed for each solo, familiar flight
}

solo.speed.data

```

There is a shameful amount of data for some individuals. I Will have to go back and see why.  

But. Now we can plot the speeds 

```{r}

boxplot(solo.speed.data, col =  rep(c(2,3) , group.vec  ))

```

seems as though there is some individual variation and some site (group) variation. 


# Group speed

```{R}

boxplot(na.omit(metrics$mean.speed[metrics$g_s == "Gro" & metrics$group.num == 1]),
              na.omit(metrics$mean.speed[metrics$g_s == "Gro" & metrics$group.num == 2]), col = c(2,3))

```


# Group median, solo median and the difference (delta)

```{r}

#group median
median.group = c(rep(median( na.omit(metrics$mean.speed[metrics$g_s == "Gro" & metrics$group.num == 1])),  group.vec[1]),
                 rep(median( na.omit(metrics$mean.speed[metrics$g_s == "Gro" & metrics$group.num == 2])), group.vec[2]))

# solo median
median.ind = apply(solo.speed.data, 2, median, na.rm = T)

# delta ( and absolute delta )

delta = median.ind - median.group
abs.delta = abs(delta)

```


# Fission from group

```{r}

len =  nrow(metrics[metrics$pigeon == 69 &metrics$g_s == "Gro"  ,])# same as above
                                                              

fission.data = array(NA, c(len,  6, length(unique(metrics$pigeon))))
               
                                                              
for (i in 1:length(unique(metrics$pigeon))){ # for each unique pigeon

  fission.data[,1,i] =  metrics$num.fission.events[metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Gro"]
  fission.data[,2,i] = metrics$length.fission.events [metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Gro"]
  fission.data[,3,i] = metrics$length.between.fission.events [metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Gro"]
  fission.data[,4,i] = metrics$proportion.time.fission[metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Gro"]
  fission.data[,5,i] = metrics$dist2centroid[metrics$pigeon == unique(metrics$pigeon)[i] & metrics$g_s == "Gro"]
  
   # get mean speed for each solo, familiar flight
}

for (i in 1:length(unique(metrics$pigeon))){
  
  for ( j in  1:len){
  fission.data[j,6,i] = sum(eval(parse(text = fission.data[j,2,i])))

}
}

# length fis


length.fis = matrix(as.numeric(fission.data[,6,])[as.numeric(fission.data[,6,]) > 30] , nrow =len)

time.fissioned.from.group = colSums(length.fis[c(1:9, 11:23),], na.rm = T)

# prop fis

prop.fis = matrix(as.numeric(fission.data[,4,]), nrow =len)

percent.time.fis = colMeans(prop.fis, na.rm = T)


# centroid

cent = matrix(as.numeric(fission.data[,5,]), nrow =len)

dist2cent = colMeans(cent, na.rm = T)



```

# Morphometrics

```{R}





load( file.path(  PROJHOME , "smallDFs" , "morpho.rda"))

{print(unique(metrics$pigeon))
print(morpho$Pigeon) }
```

need to remove 90

```{R}

if ( type == "finishers"){
  morpho = morpho[-which(morpho$Pigeon == 90),]
}

{print(unique(metrics$pigeon))
print(morpho$Pigeon)}

```

Same length, not same order

```{R}

morpho = morpho[rank(unique(metrics$pigeon)),]

morpho$Pigeon == unique(metrics$pigeon)
```

Nice! 

```{R}

mass = summary(lm(delta~ morpho$mean.mass))$coeff
tars = summary(lm(delta~ morpho$TarsoMetatarsus))$coeff
mas.tars = summary(lm(morpho$mean.mass~ morpho$TarsoMetatarsus))

par( mfrow = c(2,1))

{plot(delta~ moarpho$mean.mass, xlab = "WAIT")
abline(mass[1,1], mass[2,1])
legend("bottomright", legend = paste( "p =" ,round(mass[2,4], 3)))
plot(delta~ morpho$TarsoMetatarsus , xlab = "Tarsus length (cm)")
abline(tars[1,1], tars[2,1])
legend("bottomright", legend = paste( "p =" ,round(tars[2,4], 3)))}



```

# Time stationary during group flights


```{R}

stationary.in.group = 1:17
stationary.in.solo= 1:17

number.fission = 1:17

  for ( i in 1:17){

  stationary.in.group[i] =   length(which(
                                  na.omit(metrics$time.stationary[ metrics$g_s == "Gro" &
                                                                   metrics$pigeon == unique(metrics$pigeon)[i] ])
                                                                                                            >40) ) # 5 is arbitrary
  stationary.in.solo[i] =   length(which(
                                  na.omit(metrics$time.stationary[ metrics$g_s == "Sol" &
                                       metrics$pigeon == unique(metrics$pigeon)[i] ])

    >5) ) # 5 is arbitrary

  number.fission[i] =   length(which(na.omit(metrics$num.fission.events [ metrics$g_s == "Gro" &
                                       metrics$pigeon == unique(metrics$pigeon)[i] ]) >0))
  }

m1 = lm( stationary.in.group ~ delta )
m2 = lm( stationary.in.group ~ delta)
m3 = lm( number.fission ~ delta)

m4 = lm( stationary.in.group ~ time.fissioned.from.group)
m5 = lm( stationary.in.group ~ percent.time.fis)
m6 = lm( stationary.in.group ~ dist2cent)

m7 = lm( time.fissioned.from.group ~ delta)
m8 = lm( percent.time.fis ~ delta)
m9 = lm( dist2cent ~ delta)

for ( i in 1:9){
print(summary( get(paste0 ( "m" , i)))$coeff)
}
par(mfrow = c(3,3))
{plot( stationary.in.group ~ delta )
plot( stationary.in.group ~ delta)
plot( number.fission ~ delta)

plot( stationary.in.group ~ time.fissioned.from.group)
plot( stationary.in.group ~ percent.time.fis)
plot( stationary.in.group ~ dist2cent)

plot( time.fissioned.from.group ~ delta)
plot( percent.time.fis ~ delta)
plot( dist2cent ~ delta)}




```
